namespace DevPortal.Services;

using DevPortal.Models;

/// <summary>
/// Service that provides demo-specific EasyAgent settings based on the web app name.
/// This is used to simulate different configurations for different apps during demos.
/// </summary>
public class DemoSettingsService
{
    private readonly EasyAgentSettings _defaultSettings;

    // TaskTimer demo settings
    private static readonly EasyAgentSettings TaskTimerSettings = new()
    {
        WEBSITE_EASYAGENT_FOUNDRY_AGENTID = "asst_SV1ERgG7lGc9rchC1MyIUhz5",
        WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL = "gpt-4o",
        WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL = "text-embedding-3-small",
        WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT = "https://foundry5ndr.services.ai.azure.com/api/projects/test-easy-agent3-foundryproject",
        WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC = """{"openapi":"3.0.0","info":{"title":"TaskTimer API","description":"A simple alert management system.","version":"1.0.0"},"servers":[{"url":"https://task-timer.azurewebsites.net"}],"tags":[{"name":"Alerts","description":"Operations related to alert lifecycle"}],"paths":{"/alerts":{"get":{"tags":["Alerts"],"summary":"Get all alerts","operationId":"getAllAlerts","responses":{"200":{"description":"A list of alerts","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/Alert"}}}}}}},"post":{"tags":["Alerts"],"summary":"Create a new alert","operationId":"createAlert","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/NewAlert"}}}},"responses":{"201":{"description":"Alert created successfully","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Alert"}}}}}}},"/alerts/{id}":{"get":{"tags":["Alerts"],"summary":"Get alert by ID","operationId":"getAlertById","parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"}}],"responses":{"200":{"description":"Alert details","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Alert"}}}},"404":{"description":"Alert not found"}}},"delete":{"tags":["Alerts"],"summary":"Delete alert by ID","operationId":"deleteAlert","parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"}}],"responses":{"204":{"description":"Alert deleted"}}}}},"components":{"schemas":{"Alert":{"type":"object","properties":{"id":{"type":"string"},"message":{"type":"string"},"countdown":{"type":"integer","description":"Current countdown time in seconds"},"originalCountdown":{"type":"integer","description":"Original countdown time when alert was created"},"createdAt":{"type":"string","format":"date-time","readOnly":true}}},"NewAlert":{"type":"object","required":["message","countdown"],"properties":{"message":{"type":"string"},"countdown":{"type":"integer","minimum":1}}}}}}""",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT = "https://test-easy-agent3-cosmos.documents.azure.com:443/",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME = "RAGDatabase",
        WEBSITE_MANAGED_CLIENT_ID = "9b22dd9c-d1da-4456-9ca3-4cb043516de5",
        UserAssignedIdentityResourceId = "/subscriptions/50821c37-1271-4210-8e1f-568acc6ecc66/resourcegroups/ai-testdeploy-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/test-easy-agent3-identity"
    };

    // TripTastic demo settings
    private static readonly EasyAgentSettings TripTasticSettings = new()
    {
        WEBSITE_EASYAGENT_FOUNDRY_AGENTID = "asst_e2ir9SqhgwJc7OjXTMYCTb1w",
        WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL = "gpt-4o",
        WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL = "text-embedding-3-small",
        WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT = "https://foundrybmxv.services.ai.azure.com/api/projects/triptastic-foundryproject",
        WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC = """{"openapi":"3.0.3","info":{"title":"TripTastic API","description":"Travel API for searching and booking flights and hotels. Supported destinations: New York (JFK), Los Angeles (LAX), Chicago (ORD), Dallas (DFW), Denver (DEN), San Francisco (SFO), Seattle (SEA), Miami (MIA), Boston (BOS), Atlanta (ATL), London (LHR), Paris (CDG), Frankfurt (FRA), Tokyo (NRT), Sydney (SYD). IMPORTANT: Call /api/System/current-date first to get today's date.","version":"1.0.0"},"servers":[{"url":"https://triptastic.azurewebsites.net"}],"paths":{"/api/System/current-date":{"get":{"operationId":"getCurrentDate","summary":"Get the current date - CALL THIS FIRST before planning any trips","description":"Returns the current date in UTC. Essential for AI agents to get temporal context. All travel dates must be future dates relative to this.","responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CurrentDateResponse"}}}}}}},"/api/TripPlanner/plan":{"get":{"operationId":"planTrip","summary":"Get flight and hotel options for a round-trip","description":"Returns available outbound flights (origin to destination on departure date), return flights (destination to origin on return date), and hotels at the destination. Use the IDs from the results to add items to cart.","parameters":[{"name":"origin","in":"query","required":true,"schema":{"type":"string"},"description":"Origin airport code (e.g., SEA, JFK, LAX)"},{"name":"destination","in":"query","required":true,"schema":{"type":"string"},"description":"Destination airport code (e.g., LAX, CDG, NRT)"},{"name":"departureDate","in":"query","required":true,"schema":{"type":"string","format":"date"},"description":"Departure date (YYYY-MM-DD)"},{"name":"returnDate","in":"query","required":true,"schema":{"type":"string","format":"date"},"description":"Return date (YYYY-MM-DD)"},{"name":"travelers","in":"query","schema":{"type":"integer","default":1},"description":"Number of travelers"}],"responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/TripPlan"}}}}}}},"/api/Cart":{"get":{"operationId":"getCart","summary":"Get the current shopping cart","description":"Returns the current shopping cart with all items (flights and hotels).","responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CartResponse"}}}}}},"delete":{"operationId":"clearCart","summary":"Clear all items from the cart","description":"Removes all flights and hotels from the shopping cart.","responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CartResponse"}}}}}}},"/api/Cart/flights":{"post":{"operationId":"addFlightToCart","summary":"Add a flight to the shopping cart","description":"Adds a flight to the cart. Use the flight ID from planTrip results. Add both outbound and return flights.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/AddFlightToCartRequest"}}}},"responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CartResponse"}}}},"400":{"description":"Bad request"},"404":{"description":"Flight not found"}}}},"/api/Cart/hotels":{"post":{"operationId":"addHotelToCart","summary":"Add a hotel to the shopping cart","description":"Adds a hotel reservation to the cart. Use the hotel ID from planTrip results.","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/AddHotelToCartRequest"}}}},"responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CartResponse"}}}},"400":{"description":"Bad request"},"404":{"description":"Hotel not found"}}}},"/api/Cart/checkout":{"post":{"operationId":"checkout","summary":"Checkout and book the trip","description":"Completes the checkout process, books all items in the cart, and creates a confirmed trip. The cart is cleared after successful checkout.","responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CheckoutResponse"}}}},"400":{"description":"Cart is empty"}}}},"/api/Cart/trips":{"get":{"operationId":"getAllTrips","summary":"Get all booked trips","description":"Returns all trips that have been booked.","responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/BookedTripsResponse"}}}}}}},"/api/Cart/trips/{tripId}":{"get":{"operationId":"getTrip","summary":"Get a specific booked trip","description":"Returns details of a specific booked trip by ID.","parameters":[{"name":"tripId","in":"path","required":true,"schema":{"type":"string","format":"uuid"},"description":"The trip ID"}],"responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/BookedTripResponse"}}}},"404":{"description":"Trip not found"}}}},"/api/Cart/trips/{tripId}/cancel":{"post":{"operationId":"cancelTrip","summary":"Cancel a booked trip","description":"Cancels a previously booked trip.","parameters":[{"name":"tripId","in":"path","required":true,"schema":{"type":"string","format":"uuid"},"description":"The trip ID to cancel"}],"responses":{"200":{"description":"Success","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CancelTripResponse"}}}},"404":{"description":"Trip not found"}}}}},"components":{"schemas":{"CurrentDateResponse":{"type":"object","description":"Current date information for trip planning","properties":{"currentDateFormatted":{"type":"string","description":"Current date as YYYY-MM-DD string"},"dayOfWeek":{"type":"string","description":"Day of the week"},"tomorrow":{"type":"string","format":"date","description":"Tomorrow's date"}}},"Flight":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"airline":{"type":"string"},"flightNumber":{"type":"string"},"origin":{"type":"string"},"destination":{"type":"string"},"departureTime":{"type":"string","format":"date-time"},"arrivalTime":{"type":"string","format":"date-time"},"price":{"type":"number"}}},"Hotel":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"name":{"type":"string"},"location":{"type":"string"},"starRating":{"type":"integer"},"pricePerNight":{"type":"number"},"amenities":{"type":"array","items":{"type":"string"}}}},"HotelAvailability":{"type":"object","properties":{"hotel":{"$ref":"#/components/schemas/Hotel"},"totalPrice":{"type":"number"},"nights":{"type":"integer"}}},"TripPlan":{"type":"object","description":"Available flights and hotels for a trip. Use the IDs to add items to cart.","properties":{"origin":{"type":"string"},"destination":{"type":"string"},"departureDate":{"type":"string","format":"date"},"returnDate":{"type":"string","format":"date"},"nights":{"type":"integer"},"travelers":{"type":"integer"},"outboundFlights":{"type":"array","items":{"$ref":"#/components/schemas/Flight"},"description":"Flights from origin to destination on departure date"},"returnFlights":{"type":"array","items":{"$ref":"#/components/schemas/Flight"},"description":"Flights from destination to origin on return date"},"hotels":{"type":"array","items":{"$ref":"#/components/schemas/HotelAvailability"},"description":"Hotels at the destination"}}},"AddFlightToCartRequest":{"type":"object","required":["flightId"],"properties":{"flightId":{"type":"string","format":"uuid","description":"The flight ID from planTrip results"},"passengers":{"type":"integer","default":1,"description":"Number of passengers"}}},"AddHotelToCartRequest":{"type":"object","required":["hotelId","checkInDate","checkOutDate"],"properties":{"hotelId":{"type":"string","format":"uuid","description":"The hotel ID from planTrip results"},"checkInDate":{"type":"string","format":"date","description":"Check-in date (same as departure date)"},"checkOutDate":{"type":"string","format":"date","description":"Check-out date (same as return date)"},"rooms":{"type":"integer","default":1,"description":"Number of rooms"},"guests":{"type":"integer","default":1,"description":"Number of guests"}}},"CartResponse":{"type":"object","properties":{"items":{"type":"array","items":{"$ref":"#/components/schemas/CartItem"}},"totalItems":{"type":"integer"},"totalPrice":{"type":"number"}}},"CartItem":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"type":{"type":"string","enum":["flight","hotel"]},"description":{"type":"string"},"totalPrice":{"type":"number"},"flight":{"$ref":"#/components/schemas/CartFlightInfo"},"hotel":{"$ref":"#/components/schemas/CartHotelInfo"}}},"CartFlightInfo":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"airline":{"type":"string"},"flightNumber":{"type":"string"},"origin":{"type":"string"},"destination":{"type":"string"},"departureTime":{"type":"string","format":"date-time"},"arrivalTime":{"type":"string","format":"date-time"},"pricePerSeat":{"type":"number"},"passengers":{"type":"integer"}}},"CartHotelInfo":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"name":{"type":"string"},"location":{"type":"string"},"starRating":{"type":"integer"},"pricePerNight":{"type":"number"},"checkInDate":{"type":"string","format":"date"},"checkOutDate":{"type":"string","format":"date"},"nights":{"type":"integer"},"rooms":{"type":"integer"},"guests":{"type":"integer"}}},"CheckoutResponse":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"bookedTrip":{"$ref":"#/components/schemas/BookedTripResponse"}}},"BookedTripsResponse":{"type":"object","properties":{"trips":{"type":"array","items":{"$ref":"#/components/schemas/BookedTripResponse"}},"totalTrips":{"type":"integer"}}},"BookedTripResponse":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"confirmationCode":{"type":"string"},"status":{"type":"string"},"bookedAt":{"type":"string","format":"date-time"},"totalPrice":{"type":"number"},"flights":{"type":"array","items":{"$ref":"#/components/schemas/BookedFlightInfo"}},"hotels":{"type":"array","items":{"$ref":"#/components/schemas/BookedHotelInfo"}}}},"BookedFlightInfo":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"confirmationCode":{"type":"string"},"airline":{"type":"string"},"flightNumber":{"type":"string"},"origin":{"type":"string"},"destination":{"type":"string"},"departureTime":{"type":"string","format":"date-time"},"arrivalTime":{"type":"string","format":"date-time"},"passengers":{"type":"integer"},"pricePerSeat":{"type":"number"},"totalPrice":{"type":"number"}}},"BookedHotelInfo":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"confirmationCode":{"type":"string"},"hotelName":{"type":"string"},"location":{"type":"string"},"starRating":{"type":"integer"},"checkInDate":{"type":"string","format":"date"},"checkOutDate":{"type":"string","format":"date"},"nights":{"type":"integer"},"rooms":{"type":"integer"},"guests":{"type":"integer"},"pricePerNight":{"type":"number"},"totalPrice":{"type":"number"}}},"CancelTripResponse":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"tripId":{"type":"string","format":"uuid"}}}}}}""",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT = "https://triptastic-cosmos.documents.azure.com:443/",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME = "RAGDatabase",
        WEBSITE_MANAGED_CLIENT_ID = "12122310-9fff-49c5-b679-c9d86864f0fc",
        UserAssignedIdentityResourceId = "/subscriptions/50821c37-1271-4210-8e1f-568acc6ecc66/resourcegroups/ai-testdeploy-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/triptastic-identity"
    };

    public DemoSettingsService(EasyAgentSettings defaultSettings)
    {
        _defaultSettings = defaultSettings;
    }

    /// <summary>
    /// Gets the EasyAgent settings for a specific web app.
    /// Returns app-specific settings for demo apps (tasktimer, triptastic),
    /// or the default settings from configuration for other apps.
    /// </summary>
    public EasyAgentSettings GetSettingsForApp(string webAppName)
    {
        if (string.IsNullOrEmpty(webAppName))
            return _defaultSettings;

        // Case-insensitive matching for demo apps
        var normalizedName = webAppName.ToLowerInvariant();

        // TaskTimer gets its own settings
        if (normalizedName.Contains("tasktimer") || normalizedName.Contains("task-timer"))
        {
            return TaskTimerSettings;
        }

        // TripTastic gets its own settings
        if (normalizedName.Contains("triptastic"))
        {
            return TripTasticSettings;
        }

        // All other apps use the default settings from appsettings.json
        return _defaultSettings;
    }
}
