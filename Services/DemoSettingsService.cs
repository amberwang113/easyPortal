namespace DevPortal.Services;

using DevPortal.Models;

/// <summary>
/// Service that provides demo-specific EasyAgent settings based on the web app name.
/// This is used to simulate different configurations for different apps during demos.
/// </summary>
public class DemoSettingsService
{
    private readonly EasyAgentSettings _defaultSettings;

    // TaskTimer demo settings
    private static readonly EasyAgentSettings TaskTimerSettings = new()
    {
        WEBSITE_EASYAGENT_FOUNDRY_AGENTID = "asst_SV1ERgG7lGc9rchC1MyIUhz5",
        WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL = "gpt-4o",
        WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL = "text-embedding-3-small",
        WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT = "https://foundry5ndr.services.ai.azure.com/api/projects/test-easy-agent3-foundryproject",
        WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC = """{"openapi":"3.0.0","info":{"title":"TaskTimer API","description":"A simple alert management system.","version":"1.0.0"},"servers":[{"url":"https://task-timer.azurewebsites.net"}],"tags":[{"name":"Alerts","description":"Operations related to alert lifecycle"}],"paths":{"/alerts":{"get":{"tags":["Alerts"],"summary":"Get all alerts","operationId":"getAllAlerts","responses":{"200":{"description":"A list of alerts","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/Alert"}}}}}}},"post":{"tags":["Alerts"],"summary":"Create a new alert","operationId":"createAlert","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/NewAlert"}}}},"responses":{"201":{"description":"Alert created successfully","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Alert"}}}}}}},"/alerts/{id}":{"get":{"tags":["Alerts"],"summary":"Get alert by ID","operationId":"getAlertById","parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"}}],"responses":{"200":{"description":"Alert details","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Alert"}}}},"404":{"description":"Alert not found"}}},"delete":{"tags":["Alerts"],"summary":"Delete alert by ID","operationId":"deleteAlert","parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"}}],"responses":{"204":{"description":"Alert deleted"}}}}},"components":{"schemas":{"Alert":{"type":"object","properties":{"id":{"type":"string"},"message":{"type":"string"},"countdown":{"type":"integer","description":"Current countdown time in seconds"},"originalCountdown":{"type":"integer","description":"Original countdown time when alert was created"},"createdAt":{"type":"string","format":"date-time","readOnly":true}}},"NewAlert":{"type":"object","required":["message","countdown"],"properties":{"message":{"type":"string"},"countdown":{"type":"integer","minimum":1}}}}}}""",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT = "https://test-easy-agent3-cosmos.documents.azure.com:443/",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME = "RAGDatabase",
        WEBSITE_MANAGED_CLIENT_ID = "9b22dd9c-d1da-4456-9ca3-4cb043516de5",
        UserAssignedIdentityResourceId = "/subscriptions/50821c37-1271-4210-8e1f-568acc6ecc66/resourcegroups/ai-testdeploy-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/test-easy-agent3-identity"
    };

    // TripTastic demo settings
    private static readonly EasyAgentSettings TripTasticSettings = new()
    {
        WEBSITE_EASYAGENT_FOUNDRY_AGENTID = "asst_e2ir9SqhgwJc7OjXTMYCTb1w",
        WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL = "gpt-4o",
        WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL = "text-embedding-3-small",
        WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT = "https://foundrybmxv.services.ai.azure.com/api/projects/triptastic-foundryproject",
        WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC = """{"openapi":"3.0.3","info":{"title":"TripTastic API","description":"Travel API for flights and hotels. Flights use airport codes (e.g. JFK, LAX). Hotels use city names (e.g. New York, Los Angeles) or airport codes. Call getCurrentDate first, then getAirports or getLocations to discover valid values.","version":"2.0.0"},"servers":[{"url":"https://triptastic.azurewebsites.net"}],"paths":{"/api/System/current-date":{"get":{"operationId":"getCurrentDate","summary":"Get current date - CALL FIRST","responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DateInfo"}}}}}}},"/api/Flights/airports":{"get":{"operationId":"getAirports","summary":"List available airports with their codes and city names","responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/Airport"}}}}}}}},"/api/Flights/search":{"get":{"operationId":"searchFlights","summary":"Search flights on a route. Use airport codes (not city names) for origin and destination.","parameters":[{"name":"origin","in":"query","required":true,"description":"Origin airport code (e.g. JFK, LAX, ORD). Use getAirports to list valid codes.","schema":{"type":"string","example":"JFK"}},{"name":"destination","in":"query","required":true,"description":"Destination airport code (e.g. LAX, LHR, NRT). Use getAirports to list valid codes.","schema":{"type":"string","example":"LAX"}},{"name":"departureDate","in":"query","required":true,"description":"Departure date in YYYY-MM-DD format. Must be a future date.","schema":{"type":"string","format":"date"}},{"name":"passengers","in":"query","description":"Number of passengers.","schema":{"type":"integer","default":1}}],"responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/FlightList"}}}}}}},"/api/Hotels/locations":{"get":{"operationId":"getLocations","summary":"List available hotel locations (city names) with hotel counts and price ranges","responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/Location"}}}}}}}},"/api/Hotels/search":{"get":{"operationId":"searchHotels","summary":"Search hotels with pricing for dates. Use a city name (e.g. 'New York') or airport code (e.g. 'JFK') for location.","parameters":[{"name":"location","in":"query","required":true,"description":"City name (e.g. 'New York', 'London', 'Tokyo') or airport code (e.g. 'JFK'). City names are preferred; use getLocations to list valid city names.","schema":{"type":"string","example":"New York"}},{"name":"checkInDate","in":"query","required":true,"description":"Check-in date in YYYY-MM-DD format.","schema":{"type":"string","format":"date"}},{"name":"checkOutDate","in":"query","required":true,"description":"Check-out date in YYYY-MM-DD format. Must be after checkInDate.","schema":{"type":"string","format":"date"}},{"name":"guests","in":"query","description":"Number of guests.","schema":{"type":"integer","default":1}},{"name":"rooms","in":"query","description":"Number of rooms.","schema":{"type":"integer","default":1}}],"responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HotelSearchResult"}}}}}}},"/api/TripPlanner/plan":{"get":{"operationId":"planTrip","summary":"Plan round-trip with flights and hotel. Uses airport codes for origin/destination; hotel lookup is resolved automatically.","parameters":[{"name":"origin","in":"query","required":true,"description":"Origin airport code (e.g. JFK).","schema":{"type":"string","example":"JFK"}},{"name":"destination","in":"query","required":true,"description":"Destination airport code (e.g. LAX).","schema":{"type":"string","example":"LAX"}},{"name":"departureDate","in":"query","required":true,"description":"Departure date in YYYY-MM-DD format.","schema":{"type":"string","format":"date"}},{"name":"returnDate","in":"query","required":true,"description":"Return date in YYYY-MM-DD format. Must be after departureDate.","schema":{"type":"string","format":"date"}},{"name":"travelers","in":"query","description":"Number of travelers.","schema":{"type":"integer","default":1}}],"responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/TripPlan"}}}}}}},"/api/Cart":{"get":{"operationId":"getCart","summary":"Get shopping cart","responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Cart"}}}}}},"delete":{"operationId":"clearCart","summary":"Clear cart","responses":{"200":{"description":"OK"}}}},"/api/Cart/flights":{"post":{"operationId":"addFlight","summary":"Add flight to cart","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["flightId"],"properties":{"flightId":{"type":"string","format":"uuid","description":"Flight ID from searchFlights results."},"passengers":{"type":"integer","default":1}}}}}},"responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Cart"}}}}}}},"/api/Cart/hotels":{"post":{"operationId":"addHotel","summary":"Add hotel to cart","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["hotelId","checkInDate","checkOutDate"],"properties":{"hotelId":{"type":"string","format":"uuid","description":"Hotel ID from searchHotels results."},"checkInDate":{"type":"string","format":"date","description":"Check-in date (YYYY-MM-DD)."},"checkOutDate":{"type":"string","format":"date","description":"Check-out date (YYYY-MM-DD)."},"rooms":{"type":"integer","default":1}}}}}},"responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Cart"}}}}}}},"/api/Cart/checkout":{"post":{"operationId":"checkout","summary":"Complete booking","responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/BookingConfirmation"}}}}}}},"/api/Cart/trips":{"get":{"operationId":"getTrips","summary":"Get all booked trips","responses":{"200":{"description":"OK","content":{"application/json":{"schema":{"type":"object","properties":{"trips":{"type":"array","items":{"$ref":"#/components/schemas/BookedTrip"}},"totalTrips":{"type":"integer"}}}}}}}}},"/api/Cart/trips/{tripId}/cancel":{"post":{"operationId":"cancelTrip","summary":"Cancel a trip","parameters":[{"name":"tripId","in":"path","required":true,"schema":{"type":"string","format":"uuid"}}],"responses":{"200":{"description":"OK"}}}}},"components":{"schemas":{"DateInfo":{"type":"object","properties":{"currentDateFormatted":{"type":"string"},"tomorrow":{"type":"string"},"dayOfWeek":{"type":"string"}}},"Airport":{"type":"object","description":"An airport with its 3-letter IATA code and corresponding city name.","properties":{"code":{"type":"string","description":"3-letter airport code (e.g. JFK). Use this for flight search origin/destination."},"city":{"type":"string","description":"City name (e.g. New York). Use this for hotel search location."}}},"Location":{"type":"object","description":"A hotel location (city name) with availability summary.","properties":{"name":{"type":"string","description":"City name to use as the 'location' parameter in searchHotels."},"hotelCount":{"type":"integer"},"minPricePerNight":{"type":"number"},"maxPricePerNight":{"type":"number"}}},"Flight":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"airline":{"type":"string"},"flightNumber":{"type":"string"},"origin":{"type":"string"},"destination":{"type":"string"},"departureTime":{"type":"string","format":"date-time"},"arrivalTime":{"type":"string","format":"date-time"},"price":{"type":"number"},"availableSeats":{"type":"integer"}}},"FlightList":{"type":"object","properties":{"flights":{"type":"array","items":{"$ref":"#/components/schemas/Flight"}},"totalResults":{"type":"integer"}}},"Hotel":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"name":{"type":"string"},"location":{"type":"string"},"starRating":{"type":"integer"},"pricePerNight":{"type":"number"},"availableRooms":{"type":"integer"},"amenities":{"type":"array","items":{"type":"string"}}}},"HotelAvailability":{"type":"object","properties":{"hotel":{"$ref":"#/components/schemas/Hotel"},"totalPrice":{"type":"number"},"nights":{"type":"integer"}}},"HotelSearchResult":{"type":"object","properties":{"hotels":{"type":"array","items":{"$ref":"#/components/schemas/HotelAvailability"}},"totalResults":{"type":"integer"}}},"TripPlan":{"type":"object","properties":{"origin":{"type":"string"},"destination":{"type":"string"},"nights":{"type":"integer"},"outboundFlights":{"type":"array","items":{"$ref":"#/components/schemas/Flight"}},"returnFlights":{"type":"array","items":{"$ref":"#/components/schemas/Flight"}},"hotels":{"type":"array","items":{"$ref":"#/components/schemas/HotelAvailability"}}}},"Cart":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"type":{"type":"string","enum":["flight","hotel"]},"description":{"type":"string"},"totalPrice":{"type":"number"}}}},"totalItems":{"type":"integer"},"totalPrice":{"type":"number"}}},"BookingConfirmation":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"bookedTrip":{"$ref":"#/components/schemas/BookedTrip"}}},"BookedTrip":{"type":"object","properties":{"id":{"type":"string","format":"uuid"},"confirmationCode":{"type":"string"},"status":{"type":"string"},"totalPrice":{"type":"number"},"bookedAt":{"type":"string","format":"date-time"}}}}}}""",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT = "https://triptastic-cosmos.documents.azure.com:443/",
        WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME = "RAGDatabase",
        WEBSITE_MANAGED_CLIENT_ID = "12122310-9fff-49c5-b679-c9d86864f0fc",
        UserAssignedIdentityResourceId = "/subscriptions/50821c37-1271-4210-8e1f-568acc6ecc66/resourcegroups/ai-testdeploy-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/triptastic-identity"
    };

    public DemoSettingsService(EasyAgentSettings defaultSettings)
    {
        _defaultSettings = defaultSettings;
    }

    /// <summary>
    /// Gets the EasyAgent settings for a specific web app.
    /// Returns app-specific settings for demo apps (tasktimer, triptastic),
    /// or the default settings from configuration for other apps.
    /// </summary>
    public EasyAgentSettings GetSettingsForApp(string webAppName)
    {
        if (string.IsNullOrEmpty(webAppName))
            return _defaultSettings;

        // Case-insensitive matching for demo apps
        var normalizedName = webAppName.ToLowerInvariant();

        // TaskTimer gets its own settings
        if (normalizedName.Contains("tasktimer") || normalizedName.Contains("task-timer"))
        {
            return TaskTimerSettings;
        }

        // TripTastic gets its own settings
        if (normalizedName.Contains("triptastic"))
        {
            return TripTasticSettings;
        }

        // All other apps use the default settings from appsettings.json
        return _defaultSettings;
    }
}
