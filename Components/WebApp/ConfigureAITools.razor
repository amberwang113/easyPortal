@using DevPortal.Models
@using DevPortal.Services
@using Microsoft.Extensions.Options
@inject ApiService ApiService
@inject IOptions<EasyAgentSettings> EasyAgentConfig

<div class="card">
    <div class="card-title">AI Integration</div>
    <div class="form-help" style="margin-bottom: 20px;">
        Add AI-powered capabilities to your web application. Select one or more output types below.
    </div>
    
    <div class="form-group">
        <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Output Types</label>
        
        <div class="output-checkbox-group">
            <label class="output-checkbox-item">
                <input type="checkbox" @bind="mcpServerEnabled" />
                <span class="output-checkbox-label">MCP Server</span>
                <span class="output-checkbox-desc">Expose APIs as tools via Model Context Protocol</span>
            </label>
            
            <label class="output-checkbox-item">
                <input type="checkbox" @bind="endpointEnabled" />
                <span class="output-checkbox-label">Endpoint</span>
                <span class="output-checkbox-desc">REST API endpoint with AI-powered responses</span>
            </label>
            
            <label class="output-checkbox-item">
                <input type="checkbox" @bind="nlwebEnabled" />
                <span class="output-checkbox-label">NLWeb</span>
                <span class="output-checkbox-desc">Natural language web interface with chat widget</span>
            </label>
        </div>
    </div>
</div>

@if (mcpServerEnabled)
{
    <div class="card">
        <div class="card-title">MCP Server Configuration</div>
        
        <div class="form-group">
            <label class="form-label">OpenAPI Specification</label>
            <textarea class="form-textarea" @bind="mcpOpenApiSpec" placeholder="Paste OpenAPI 3.0 JSON/YAML specification for your APIs..." style="min-height: 150px; font-family: monospace; font-size: 12px;"></textarea>
            <div class="form-help">The OpenAPI spec defines which API endpoints will be exposed as MCP tools.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">MCP Endpoint Path</label>
            <input type="text" class="form-input" @bind="mcpEndpointPath" placeholder="/ai/mcp" />
            <div class="form-help">The path where AI assistants will discover your MCP server.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Server Name</label>
            <input type="text" class="form-input" @bind="mcpServerName" placeholder="my-mcp-server" />
        </div>
        
        <div class="form-group">
            <label class="form-label">Server Description</label>
            <textarea class="form-textarea" @bind="mcpServerDescription" placeholder="Describe what your MCP server provides..."></textarea>
        </div>
    </div>
}

@if (endpointEnabled)
{
    <div class="card">
        <div class="card-title">Endpoint Configuration</div>
        
        <div class="form-group">
            <label class="form-label">Endpoint Path</label>
            <input type="text" class="form-input" @bind="aiEndpointPath" placeholder="ai/chat" />
            <div class="form-help">The API path where AI chat requests will be handled (e.g., /ai/chat).</div>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">
                <input type="checkbox" @bind="ragEnabled" style="margin-right: 8px;" />
                <span style="font-weight: 600;">Enable RAG (Website Knowledge)</span>
            </label>
            <div class="form-help">Allow the AI to reference your website's content.</div>
        </div>
        
        @if (ragEnabled)
        {
            <div style="margin-left: 24px; margin-top: 15px;">
                <div class="form-group">
                    <label class="form-label" style="margin-bottom: 10px;">RAG Database</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="ragOption" checked="@(ragOption == "create")" @onchange='() => ragOption = "create"' />
                            <span>Create a new RAG database</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="ragOption" checked="@(ragOption == "existing")" @onchange='() => ragOption = "existing"' />
                            <span>Configure an existing database</span>
                        </label>
                    </div>
                </div>
                
                @if (ragOption == "existing")
                {
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">Cosmos DB Endpoint</label>
                        <input type="text" class="form-input" @bind="cosmosDbEndpoint" placeholder="https://your-cosmos.documents.azure.com:443/" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Database Name</label>
                        <input type="text" class="form-input" @bind="cosmosDbName" placeholder="RAGDatabase" />
                    </div>
                }
                else
                {
                    <div class="alert alert-info" style="margin-top: 15px;">
                        A new Cosmos DB database will be created automatically when you save. The database will be provisioned in your resource group.
                    </div>
                }
            </div>
        }
        
        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">
                <input type="checkbox" @bind="toolsEnabled" style="margin-right: 8px;" />
                <span style="font-weight: 600;">Enable API Tools (Function Calling)</span>
            </label>
            <div class="form-help">Allow the AI to call your application's APIs.</div>
        </div>
        
        @if (toolsEnabled)
        {
            <div style="margin-left: 24px; margin-top: 10px;">
                <div class="form-group">
                    <label class="form-label">OpenAPI Specification</label>
                    <textarea class="form-textarea" @bind="openApiSpec" placeholder="Paste OpenAPI 3.0 JSON/YAML..." style="min-height: 100px; font-family: monospace; font-size: 12px;"></textarea>
                </div>
            </div>
        }
        
        <div style="margin-top: 20px;">
            <button class="btn btn-secondary" style="font-size: 13px;" @onclick="ToggleAdvancedSettings">
                @(showAdvancedSettings ? "Hide" : "Show") Advanced Settings
            </button>
        </div>
        
        @if (showAdvancedSettings)
        {
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--azure-border);">
                <div class="form-group">
                    <label class="form-label">Foundry Endpoint</label>
                    <input type="text" class="form-input" @bind="foundryEndpoint" placeholder="https://your-foundry.services.ai.azure.com/api/projects/your-project" />
                </div>
                
                <div class="form-group">
                    <label class="form-label">Agent ID</label>
                    <input type="text" class="form-input" @bind="foundryAgentId" placeholder="asst_xxxxxxxxxxxxx" />
                </div>
                
                <div class="form-group">
                    <label class="form-label">Chat Model</label>
                    <select class="form-select" @bind="chatModel">
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-35-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Embedding Model</label>
                    <select class="form-select" @bind="embeddingModel">
                        <option value="text-embedding-3-small">text-embedding-3-small</option>
                        <option value="text-embedding-3-large">text-embedding-3-large</option>
                        <option value="text-embedding-ada-002">text-embedding-ada-002</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Managed Identity Client ID</label>
                    <input type="text" class="form-input" @bind="managedClientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                </div>
            </div>
        }
    </div>
}

@if (nlwebEnabled)
{
    <div class="card">
        <div class="card-title">NLWeb Configuration</div>
        
        <div class="form-group">
            <label class="form-label">Chat Widget Path</label>
            <input type="text" class="form-input" @bind="nlwebChatPath" placeholder="/chat" />
        </div>
        
        <div class="form-group">
            <label class="form-label">Widget Position</label>
            <select class="form-select" @bind="nlwebWidgetPosition">
                <option value="bottom-right">Bottom Right</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="full-page">Full Page</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Welcome Message</label>
            <textarea class="form-textarea" @bind="nlwebWelcomeMessage" placeholder="Hello! How can I help you today?"></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">Primary Color</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="color" @bind="nlwebPrimaryColor" style="width: 50px; height: 32px; padding: 0; border: 1px solid var(--azure-border);" />
                <span style="color: var(--azure-dark-gray); font-family: monospace;">@nlwebPrimaryColor</span>
            </div>
        </div>
    </div>
}

@if (mcpServerEnabled || endpointEnabled || nlwebEnabled)
{
    <div style="margin-top: 20px;">
        <button class="btn btn-primary" @onclick="SaveConfiguration" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="loading-spinner" style="width: 14px; height: 14px; margin-right: 8px;"></span>
            }
            Save Configuration
        </button>
        <button class="btn btn-secondary" @onclick="Discard" disabled="@isSaving">Discard Changes</button>
    </div>
    
    @if (!string.IsNullOrEmpty(saveMessage))
    {
        <div class="@saveMessageClass" style="margin-top: 15px;">
            @saveMessage
        </div>
    }
    
    @if (!string.IsNullOrEmpty(detailedError))
    {
        <div class="alert alert-error" style="margin-top: 15px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Extension Installation Error Details:</div>
            <pre style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 4px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">@detailedError</pre>
        </div>
    }
}

@* Show uninstall button when AI was previously configured but now all options are unchecked *@
@if (!mcpServerEnabled && !endpointEnabled && !nlwebEnabled && wasAIConfigured)
{
    <div class="card" style="border-color: #d83b01;">
        <div class="card-title" style="color: #d83b01;">Uninstall AI Integration</div>
        <div class="form-help" style="margin-bottom: 20px;">
            AI integration was previously configured on this web app. Click below to completely remove all AI components including app settings, site extensions, managed identity, and the EasyAgentScraper webjob.
        </div>
        
        <div style="margin-top: 15px;">
            <button class="btn" style="background-color: #d83b01; color: white;" @onclick="UninstallAIIntegration" disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="loading-spinner" style="width: 14px; height: 14px; margin-right: 8px;"></span>
                }
                Uninstall AI Integration
            </button>
        </div>
        
        @if (!string.IsNullOrEmpty(saveMessage))
        {
            <div class="@saveMessageClass" style="margin-top: 15px;">
                @saveMessage
            </div>
        }
        
        @if (!string.IsNullOrEmpty(detailedError))
        {
            <div class="alert alert-error" style="margin-top: 15px;">
                <div style="font-weight: 600; margin-bottom: 8px;">Uninstall Error Details:</div>
                <pre style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 4px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">@detailedError</pre>
            </div>
        }
    </div>
}

<style>
    .output-checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .output-checkbox-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px 15px;
        border: 1px solid var(--azure-border);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .output-checkbox-item:hover {
        background-color: var(--azure-gray);
    }
    
    .output-checkbox-item input[type="checkbox"] {
        margin-top: 2px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .output-checkbox-label {
        font-weight: 600;
        font-size: 14px;
        min-width: 100px;
    }
    
    .output-checkbox-desc {
        font-size: 13px;
        color: var(--azure-dark-gray);
    }
</style>

@code {
    [Parameter]
    public WebApp? WebApp { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    // Output type toggles
    private bool mcpServerEnabled = false;
    private bool endpointEnabled = false;
    private bool nlwebEnabled = false;
    
    // Track if AI was previously configured (for showing uninstall option)
    private bool wasAIConfigured = false;
    
    // UI state
    private bool showAdvancedSettings = false;
    private bool showAddTool = false;
    private bool isSaving = false;
    private string saveMessage = string.Empty;
    private string saveMessageClass = string.Empty;
    private string detailedError = string.Empty;
    
    // Endpoint settings
    private string aiEndpointPath = "ai/chat";
    private bool ragEnabled = false;
    private string ragOption = "create"; // "create" or "existing"
    private bool toolsEnabled = false;
    
    // Azure AI Foundry settings
    private string foundryEndpoint = "";
    private string foundryAgentId = "";
    private string chatModel = "gpt-4o";
    private string embeddingModel = "text-embedding-3-small";
    private string managedClientId = "";
    
    // RAG / Cosmos DB settings
    private string cosmosDbEndpoint = "";
    private string cosmosDbName = "RAGDatabase";
    
    // Tools settings
    private string openApiSpec = "";
    
    // MCP Server settings
    private string mcpEndpointPath = "/ai/mcp";
    private string mcpServerName = "";
    private string mcpServerDescription = "";
    private string mcpOpenApiSpec = "";
    private List<MCPTool> mcpTools = new();
    private MCPTool newTool = new();
    
    // NLWeb settings
    private string nlwebChatPath = "/chat";
    private string nlwebWidgetPosition = "bottom-right";
    private string nlwebWelcomeMessage = "Hello! How can I help you today?";
    private string nlwebPrimaryColor = "#0078d4";

    protected override async Task OnParametersSetAsync()
    {
        if (WebApp != null)
        {
            if (string.IsNullOrEmpty(mcpServerName))
            {
                mcpServerName = $"{WebApp.Name}-server";
            }
            await LoadExistingSettings();
        }
    }

    private async Task LoadExistingSettings()
    {
        if (WebApp == null) return;
        
        // Get default settings from configuration
        var defaults = EasyAgentConfig.Value;
        
        try
        {
            var envVars = await ApiService.GetEnvironmentVariablesAsync(WebApp.Name);
            
            // Check which output types are enabled
            var outputTypes = envVars.FirstOrDefault(e => e.Name == "WEBSITE_EASYAGENT_OUTPUT_TYPES")?.Value ?? "";
            mcpServerEnabled = outputTypes.Contains("mcp-server");
            endpointEnabled = outputTypes.Contains("endpoint");
            nlwebEnabled = outputTypes.Contains("nlweb");
            
            // Load Foundry settings - use config defaults if not set in web app
            foundryEndpoint = GetValueOrDefault(envVars, "WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT", defaults.WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT);
            foundryAgentId = GetValueOrDefault(envVars, "WEBSITE_EASYAGENT_FOUNDRY_AGENTID", defaults.WEBSITE_EASYAGENT_FOUNDRY_AGENTID);
            chatModel = GetValueOrDefault(envVars, "WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL", defaults.WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL);
            embeddingModel = GetValueOrDefault(envVars, "WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL", defaults.WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL);
            managedClientId = GetValueOrDefault(envVars, "WEBSITE_MANAGED_CLIENT_ID", defaults.WEBSITE_MANAGED_CLIENT_ID);
            openApiSpec = GetValueOrDefault(envVars, "WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC", defaults.WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC);
            
            // RAG settings - use config defaults if not set
            aiEndpointPath = envVars.FirstOrDefault(e => e.Name == "WEBSITE_EASYAGENT_ENDPOINT_PATH")?.Value ?? "ai/chat";
            cosmosDbEndpoint = GetValueOrDefault(envVars, "WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT", defaults.WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT);
            cosmosDbName = GetValueOrDefault(envVars, "WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME", defaults.WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME);
            ragEnabled = !string.IsNullOrEmpty(cosmosDbEndpoint) || envVars.Any(e => e.Name == "WEBSITE_EASYAGENT_RAG_ENABLED" && e.Value == "true");
            ragOption = string.IsNullOrEmpty(envVars.FirstOrDefault(e => e.Name == "WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT")?.Value) && string.IsNullOrEmpty(defaults.WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT) ? "create" : "existing";
            toolsEnabled = !string.IsNullOrEmpty(openApiSpec);
            
            // MCP settings
            mcpEndpointPath = envVars.FirstOrDefault(e => e.Name == "WEBSITE_MCP_ENDPOINT_PATH")?.Value ?? "/ai/mcp";
            mcpServerName = envVars.FirstOrDefault(e => e.Name == "WEBSITE_MCP_SERVER_NAME")?.Value ?? $"{WebApp.Name}-server";
            mcpServerDescription = envVars.FirstOrDefault(e => e.Name == "WEBSITE_MCP_SERVER_DESCRIPTION")?.Value ?? "";
            mcpOpenApiSpec = GetValueOrDefault(envVars, "WEBSITE_EASYMCP_OPENAPI_SPEC", defaults.WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC);
            
            // Check if AI was previously configured (any WEBSITE_EASYMCP_* or WEBSITE_EASYAGENT_* settings exist)
            wasAIConfigured = envVars.Any(e => e.Name.StartsWith("WEBSITE_EASYMCP_") || e.Name.StartsWith("WEBSITE_EASYAGENT_"));
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading existing settings: {ex.Message}");
        }
    }
    
    private string GetValueOrDefault(List<EnvironmentVariable> envVars, string name, string defaultValue)
    {
        var existingValue = envVars.FirstOrDefault(e => e.Name == name)?.Value;
        return !string.IsNullOrEmpty(existingValue) ? existingValue : defaultValue;
    }

    private void ToggleAdvancedSettings() => showAdvancedSettings = !showAdvancedSettings;

    // MCP Tool management
    private void ShowAddToolDialog()
    {
        newTool = new MCPTool { Method = "GET" };
        showAddTool = true;
    }

    private void CancelAddTool()
    {
        showAddTool = false;
        newTool = new MCPTool();
    }

    private void SaveTool()
    {
        if (!string.IsNullOrWhiteSpace(newTool.Name) && !string.IsNullOrWhiteSpace(newTool.Endpoint))
        {
            mcpTools.Add(newTool);
            showAddTool = false;
            newTool = new MCPTool();
        }
    }

    private void RemoveTool(MCPTool tool)
    {
        mcpTools.Remove(tool);
    }

    private async Task SaveConfiguration()
    {
        if (WebApp == null) return;
        
        isSaving = true;
        saveMessage = string.Empty;
        detailedError = string.Empty;
        StateHasChanged();
        
        try
        {
            var existingVars = await ApiService.GetEnvironmentVariablesAsync(WebApp.Name);
            var envVarDict = existingVars.ToDictionary(e => e.Name, e => e);
            
            // Build output types string
            var outputTypes = new List<string>();
            if (mcpServerEnabled) outputTypes.Add("mcp-server");
            if (endpointEnabled) outputTypes.Add("endpoint");
            if (nlwebEnabled) outputTypes.Add("nlweb");
            
            if (outputTypes.Any())
            {
                SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_OUTPUT_TYPES", string.Join(",", outputTypes));
                
                // MCP Server settings
                if (mcpServerEnabled)
                {
                    SetEnvironmentVariable(envVarDict, "WEBSITE_MCP_ENDPOINT_PATH", mcpEndpointPath);
                    SetEnvironmentVariable(envVarDict, "WEBSITE_MCP_SERVER_NAME", mcpServerName);
                    SetEnvironmentVariable(envVarDict, "WEBSITE_MCP_SERVER_DESCRIPTION", mcpServerDescription);
                    
                    // Set the MCP OpenAPI spec
                    if (!string.IsNullOrEmpty(mcpOpenApiSpec))
                    {
                        SetEnvironmentVariable(envVarDict, "WEBSITE_EASYMCP_OPENAPI_SPEC", mcpOpenApiSpec);
                    }
                    
                    // Install EasyMCP site extension
                    saveMessage = "Installing EasyMCP extension...";
                    StateHasChanged();
                    
                    var mcpResult = await ApiService.InstallEasyMcpExtensionAsync(WebApp.Name);
                    if (!mcpResult.Success)
                    {
                        saveMessage = "Warning: Failed to install EasyMCP extension.";
                        saveMessageClass = "alert alert-warning";
                        detailedError = FormatExtensionError("EasyMCP Install", mcpResult);
                    }
                }
                else
                {
                    RemoveEnvironmentVariable(envVarDict, "WEBSITE_MCP_ENDPOINT_PATH");
                    RemoveEnvironmentVariable(envVarDict, "WEBSITE_MCP_SERVER_NAME");
                    RemoveEnvironmentVariable(envVarDict, "WEBSITE_MCP_SERVER_DESCRIPTION");
                    RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYMCP_OPENAPI_SPEC");
                    
                    // Uninstall EasyMCP extension
                    await ApiService.UninstallEasyMcpExtensionAsync(WebApp.Name);
                }
                
                // Endpoint settings
                if (endpointEnabled)
                {
                    SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_ENDPOINT_PATH", aiEndpointPath);
                    SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT", foundryEndpoint);
                    SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_AGENTID", foundryAgentId);
                    SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL", chatModel);
                    SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL", embeddingModel);
                    SetEnvironmentVariable(envVarDict, "WEBSITE_MANAGED_CLIENT_ID", managedClientId);
                    
                    if (ragEnabled)
                    {
                        SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_ENABLED", "true");
                        if (ragOption == "existing")
                        {
                            SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT", cosmosDbEndpoint);
                            SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME", cosmosDbName);
                        }
                        else
                        {
                            // Create new - the backend will provision the database
                            SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_CREATE_NEW", "true");
                            RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT");
                            RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME");
                        }
                    }
                    else
                    {
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_ENABLED");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_CREATE_NEW");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME");
                    }
                    
                    if (toolsEnabled && !string.IsNullOrEmpty(openApiSpec))
                        {
                            SetEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC", openApiSpec);
                        }
                        else
                        {
                            RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC");
                        }
                    
                        // Install EasyAgent site extension (only for Endpoint mode)
                        saveMessage = "Installing EasyAgent extension...";
                        StateHasChanged();
                    
                        var agentResult = await ApiService.InstallEasyAgentExtensionAsync(WebApp.Name);
                        if (!agentResult.Success)
                        {
                            saveMessage = "Warning: Failed to install EasyAgent extension.";
                            saveMessageClass = "alert alert-warning";
                            detailedError += (string.IsNullOrEmpty(detailedError) ? "" : "\n\n") + FormatExtensionError("EasyAgent Install", agentResult);
                        }
                        
                        // Assign User Assigned Managed Identity to the web app
                        var identityResourceId = EasyAgentConfig.Value.UserAssignedIdentityResourceId;
                        if (!string.IsNullOrEmpty(identityResourceId))
                        {
                            saveMessage = "Assigning managed identity...";
                            StateHasChanged();
                            
                            var identityResult = await ApiService.AssignUserIdentityAsync(WebApp.Name, identityResourceId);
                            if (!identityResult.Success)
                            {
                                saveMessage = "Warning: Failed to assign managed identity.";
                                saveMessageClass = "alert alert-warning";
                                detailedError += (string.IsNullOrEmpty(detailedError) ? "" : "\n\n") + FormatIdentityError("Identity Assignment", identityResult);
                            }
                        }
                    }
                    else
                    {
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_ENDPOINT_PATH");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_AGENTID");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_MANAGED_CLIENT_ID");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_ENABLED");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_CREATE_NEW");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME");
                        RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC");
                    
                        // Uninstall EasyAgent extension when Endpoint is disabled
                                await ApiService.UninstallEasyAgentExtensionAsync(WebApp.Name);
                            }
                        }
                        else
            {
                // Remove all AI-related environment variables
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_OUTPUT_TYPES");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_ENDPOINT_PATH");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_ENDPOINT");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_AGENTID");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_CHAT_MODEL");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_EMBEDDING_MODEL");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_FOUNDRY_OPENAPISPEC");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_ENABLED");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_RAG_CREATE_NEW");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_ENDPOINT");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYAGENT_SITECONTEXT_DB_NAME");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_MANAGED_CLIENT_ID");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_MCP_ENDPOINT_PATH");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_MCP_SERVER_NAME");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_MCP_SERVER_DESCRIPTION");
                RemoveEnvironmentVariable(envVarDict, "WEBSITE_EASYMCP_OPENAPI_SPEC");
                
                // Uninstall site extensions
                saveMessage = "Removing AI extensions...";
                StateHasChanged();
                
                await ApiService.UninstallEasyAgentExtensionAsync(WebApp.Name);
                await ApiService.UninstallEasyMcpExtensionAsync(WebApp.Name);
            }
            
            // Save environment variables
            saveMessage = "Saving configuration...";
            StateHasChanged();
            
            var allVars = envVarDict.Values.ToList();
            var success = await ApiService.SaveEnvironmentVariablesAsync(WebApp.Name, allVars);
            
            if (success)
            {
                if (outputTypes.Any())
                {
                    // Build dynamic success message based on what was installed
                    var installedExtensions = new List<string>();
                    if (mcpServerEnabled) installedExtensions.Add("EasyMCP");
                    if (endpointEnabled) installedExtensions.Add("EasyAgent");
                    
                    if (installedExtensions.Any())
                    {
                        saveMessage = $"AI configuration saved and {string.Join(" and ", installedExtensions)} extension(s) installed successfully!";
                    }
                    else
                    {
                        saveMessage = "AI configuration saved successfully!";
                    }
                }
                else
                {
                    saveMessage = "AI configuration removed successfully!";
                }
                saveMessageClass = "alert alert-success";
                await OnSave.InvokeAsync();
            }
            else
            {
                saveMessage = "Failed to save configuration. Please try again.";
                saveMessageClass = "alert alert-error";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving configuration: {ex.Message}");
            saveMessage = $"Error saving configuration: {ex.Message}";
            saveMessageClass = "alert alert-error";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    private void SetEnvironmentVariable(Dictionary<string, EnvironmentVariable> envVars, string name, string value)
    {
        if (envVars.ContainsKey(name))
        {
            envVars[name].Value = value;
        }
        else
        {
            envVars[name] = new EnvironmentVariable
            {
                Name = name,
                Value = value,
                Source = "App Service",
                IsSlotSetting = false,
                IsValueHidden = true
            };
        }
    }
    
    private void RemoveEnvironmentVariable(Dictionary<string, EnvironmentVariable> envVars, string name)
    {
        if (envVars.ContainsKey(name))
        {
            envVars.Remove(name);
        }
    }

    private void Discard()
    {
        mcpServerEnabled = false;
        endpointEnabled = false;
        nlwebEnabled = false;
        ragEnabled = false;
        toolsEnabled = false;
        showAdvancedSettings = false;
        saveMessage = string.Empty;
        detailedError = string.Empty;
        StateHasChanged();
    }
    
    private string FormatExtensionError(string operation, ApiService.SiteExtensionResult result)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"Operation: {operation}");
        sb.AppendLine($"Method: {result.Method ?? "N/A"}");
        sb.AppendLine($"URL: {result.RequestUrl ?? "N/A"}");
        sb.AppendLine($"Auth: {result.CredentialsUsed ?? "N/A"}");
        sb.AppendLine($"Status Code: {result.StatusCode?.ToString() ?? "N/A"}");
        sb.AppendLine($"Error: {result.ErrorMessage ?? "Unknown error"}");
        if (!string.IsNullOrEmpty(result.RawCredentials))
        {
            sb.AppendLine($"--- RAW CREDENTIALS ---");
            sb.AppendLine(result.RawCredentials);
            sb.AppendLine($"--- END CREDENTIALS ---");
        }
        if (!string.IsNullOrEmpty(result.ResponseBody))
        {
            sb.AppendLine($"Response Body: {result.ResponseBody}");
        }
        return sb.ToString();
    }
    
    private string FormatIdentityError(string operation, ApiService.IdentityAssignmentResult result)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"Operation: {operation}");
        sb.AppendLine($"URL: {result.RequestUrl ?? "N/A"}");
        sb.AppendLine($"Status Code: {result.StatusCode?.ToString() ?? "N/A"}");
        sb.AppendLine($"Error: {result.ErrorMessage ?? "Unknown error"}");
        if (!string.IsNullOrEmpty(result.ResponseBody))
        {
            sb.AppendLine($"Response Body: {result.ResponseBody}");
        }
        return sb.ToString();
    }

    /// <summary>
    /// Completely uninstalls AI integration from the web app:
    /// 1. Deletes all app settings starting with WEBSITE_EASYMCP_* or WEBSITE_EASYAGENT_*
    /// 2. Removes the associated user assigned managed identity
    /// 3. Uninstalls both EasyAgent and EasyMCP site extensions
    /// 4. Deletes the EasyAgentScraper webjob
    /// </summary>
    private async Task UninstallAIIntegration()
    {
        if (WebApp == null) return;
        
        isSaving = true;
        saveMessage = string.Empty;
        detailedError = string.Empty;
        StateHasChanged();
        
        try
        {
            // Step 1: Remove all AI-related app settings
            saveMessage = "Removing AI app settings...";
            StateHasChanged();
            
            var existingVars = await ApiService.GetEnvironmentVariablesAsync(WebApp.Name);
            var envVarDict = existingVars.ToDictionary(e => e.Name, e => e);
            
            // Find and remove all WEBSITE_EASYMCP_* and WEBSITE_EASYAGENT_* settings
            var keysToRemove = envVarDict.Keys
                .Where(k => k.StartsWith("WEBSITE_EASYMCP_") || k.StartsWith("WEBSITE_EASYAGENT_") || k == "WEBSITE_MANAGED_CLIENT_ID" || k == "WEBSITE_MCP_ENDPOINT_PATH" || k == "WEBSITE_MCP_SERVER_NAME" || k == "WEBSITE_MCP_SERVER_DESCRIPTION")
                .ToList();
            
            foreach (var key in keysToRemove)
            {
                envVarDict.Remove(key);
            }
            
            var allVars = envVarDict.Values.ToList();
            var settingsSaved = await ApiService.SaveEnvironmentVariablesAsync(WebApp.Name, allVars);
            
            if (!settingsSaved)
            {
                detailedError += "Failed to remove app settings.\n";
            }
            
            // Step 2: Remove the user assigned managed identity
            var identityResourceId = EasyAgentConfig.Value.UserAssignedIdentityResourceId;
            if (!string.IsNullOrEmpty(identityResourceId))
            {
                saveMessage = "Removing managed identity...";
                StateHasChanged();
                
                var identityResult = await ApiService.RemoveUserIdentityAsync(WebApp.Name, identityResourceId);
                if (!identityResult.Success)
                {
                    detailedError += FormatIdentityError("Identity Removal", identityResult) + "\n";
                }
            }
            
            // Step 3: Uninstall both site extensions
            saveMessage = "Uninstalling EasyAgent extension...";
            StateHasChanged();
            
            var agentResult = await ApiService.UninstallEasyAgentExtensionAsync(WebApp.Name);
            if (!agentResult.Success)
            {
                detailedError += FormatExtensionError("EasyAgent Uninstall", agentResult) + "\n";
            }
            
            saveMessage = "Uninstalling EasyMCP extension...";
            StateHasChanged();
            
            var mcpResult = await ApiService.UninstallEasyMcpExtensionAsync(WebApp.Name);
            if (!mcpResult.Success)
            {
                detailedError += FormatExtensionError("EasyMCP Uninstall", mcpResult) + "\n";
            }
            
            // Step 4: Delete the EasyAgentScraper webjob (try both triggered and continuous)
            saveMessage = "Deleting EasyAgentScraper webjob...";
            StateHasChanged();
            
            var triggeredResult = await ApiService.DeleteTriggeredWebJobAsync(WebApp.Name, "EasyAgentScraper");
            var continuousResult = await ApiService.DeleteContinuousWebJobAsync(WebApp.Name, "EasyAgentScraper");
            
            // Only report error if both failed (webjob might be either type)
            if (!triggeredResult.Success && !continuousResult.Success)
            {
                // Check if it's just a 404 (webjob doesn't exist) - that's OK
                if (triggeredResult.StatusCode != 404 && continuousResult.StatusCode != 404)
                {
                    detailedError += FormatExtensionError("WebJob Deletion", triggeredResult) + "\n";
                }
            }
            
            // Update state
            wasAIConfigured = false;
            mcpServerEnabled = false;
            endpointEnabled = false;
            nlwebEnabled = false;
            
            if (string.IsNullOrEmpty(detailedError))
            {
                saveMessage = "AI integration uninstalled successfully!";
                saveMessageClass = "alert alert-success";
            }
            else
            {
                saveMessage = "AI integration uninstalled with some warnings. Check details below.";
                saveMessageClass = "alert alert-warning";
            }
            
            await OnSave.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uninstalling AI integration: {ex.Message}");
            saveMessage = $"Error uninstalling AI integration: {ex.Message}";
            saveMessageClass = "alert alert-error";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    public class MCPTool
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Method { get; set; } = "GET";
        public string Endpoint { get; set; } = "";
    }
}
