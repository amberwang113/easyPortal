@using DevPortal.Models

<div class="card">
    <div class="card-title">MCP Server Integration</div>
    <div class="form-help" style="margin-bottom: 20px;">
        Enable Model Context Protocol (MCP) to expose your web app's APIs as tools that AI assistants can discover and use. 
        This creates an MCP server endpoint that describes your APIs in a format AI models understand.
    </div>
    
    <div class="form-group">
        <label class="form-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
            <div class="toggle-switch @(mcpEnabled ? "active" : "")" @onclick="ToggleMCP">
                <div class="toggle-slider"></div>
            </div>
            <span style="font-weight: 600;">Enable MCP Server</span>
        </label>
        <div class="form-help">
            When enabled, your web app will expose an MCP-compatible endpoint that AI assistants can connect to.
        </div>
    </div>
</div>

@if (mcpEnabled)
{
    <div class="card">
        <div class="card-title">MCP Server Configuration</div>
        
        <div class="form-group">
            <label class="form-label">MCP Endpoint Path</label>
            <input type="text" class="form-input" @bind="mcpEndpointPath" placeholder="/.well-known/mcp" />
            <div class="form-help">The path where AI assistants will discover your MCP server capabilities.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Server Name</label>
            <input type="text" class="form-input" @bind="mcpServerName" placeholder="@WebApp?.Name MCP Server" />
            <div class="form-help">A friendly name for your MCP server that AI assistants will display.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Server Description</label>
            <textarea class="form-textarea" @bind="mcpServerDescription" placeholder="Describe what your MCP server provides..."></textarea>
            <div class="form-help">Help AI assistants understand what capabilities your server offers.</div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">API Tools</div>
        <div class="form-help" style="margin-bottom: 20px;">
            Define which API endpoints to expose as MCP tools. Each tool represents an action that AI assistants can perform.
        </div>
        
        @if (mcpTools.Any())
        {
            <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                @foreach (var tool in mcpTools)
                {
                    <div style="border: 1px solid var(--azure-border); border-radius: 4px; padding: 15px; background: var(--azure-gray);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 14px;">@tool.Name</strong>
                                <span style="margin-left: 10px; padding: 2px 8px; background: var(--azure-blue); color: white; border-radius: 3px; font-size: 11px;">@tool.Method</span>
                            </div>
                            <button class="btn btn-danger" style="padding: 4px 10px; font-size: 12px;" @onclick="() => RemoveTool(tool)">Remove</button>
                        </div>
                        <div style="font-family: monospace; font-size: 12px; color: var(--azure-dark-gray); margin-bottom: 8px;">@tool.Endpoint</div>
                        <div style="font-size: 13px; color: #666;">@tool.Description</div>
                        @if (tool.Parameters.Any())
                        {
                            <div style="margin-top: 10px; font-size: 12px;">
                                <strong>Parameters:</strong>
                                @foreach (var param in tool.Parameters)
                                {
                                    <span style="margin-left: 8px; padding: 2px 6px; background: #e0e0e0; border-radius: 3px;">@param.Name (@param.Type)</span>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info" style="margin-bottom: 20px;">
                No API tools configured yet. Add tools to expose your API endpoints to AI assistants.
            </div>
        }
        
        <button class="btn btn-secondary" @onclick="ShowAddToolDialog">+ Add API Tool</button>
    </div>

    @if (showAddTool)
    {
        <div class="card" style="border: 2px solid var(--azure-blue);">
            <div class="card-title">Add New API Tool</div>
            
            <div class="form-group">
                <label class="form-label">Tool Name</label>
                <input type="text" class="form-input" @bind="newTool.Name" placeholder="e.g., get_user_profile" />
                <div class="form-help">A unique identifier for this tool (snake_case recommended).</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" @bind="newTool.Description" placeholder="Describe what this tool does..."></textarea>
                <div class="form-help">Help AI understand when and how to use this tool.</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Method</label>
                    <select class="form-select" @bind="newTool.Method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">API Endpoint</label>
                    <input type="text" class="form-input" @bind="newTool.Endpoint" placeholder="/api/users/{id}" />
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Parameters</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    @foreach (var param in newTool.Parameters)
                    {
                        <div style="display: grid; grid-template-columns: 1fr 120px 2fr auto; gap: 10px; align-items: end;">
                            <input type="text" class="form-input" @bind="param.Name" placeholder="name" />
                            <select class="form-select" @bind="param.Type">
                                <option value="string">string</option>
                                <option value="number">number</option>
                                <option value="boolean">boolean</option>
                                <option value="object">object</option>
                                <option value="array">array</option>
                            </select>
                            <input type="text" class="form-input" @bind="param.Description" placeholder="Parameter description" />
                            <button class="btn btn-danger" style="padding: 6px 10px;" @onclick="() => RemoveParameter(param)">&#10005;</button>
                        </div>
                    }
                </div>
                <button class="btn btn-secondary" style="margin-top: 10px;" @onclick="AddParameter">+ Add Parameter</button>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" @onclick="SaveTool">Save Tool</button>
                <button class="btn btn-secondary" @onclick="CancelAddTool">Cancel</button>
            </div>
        </div>
    }

    <div class="card">
        <div class="card-title">Import from OpenAPI</div>
        <div class="form-help" style="margin-bottom: 15px;">
            Automatically generate MCP tools from an existing OpenAPI 3.0 specification.
        </div>
        
        <div class="form-group">
            <label class="form-label">OpenAPI Specification URL</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" class="form-input" @bind="openApiUrl" placeholder="https://your-api.com/swagger/v1/swagger.json" style="flex: 1;" />
                <button class="btn btn-secondary" @onclick="ImportFromOpenAPI">Import</button>
            </div>
            <div class="form-help">Or paste your OpenAPI JSON/YAML below:</div>
        </div>
        
        <div class="form-group">
            <textarea class="form-textarea" @bind="openApiSpec" placeholder="Paste OpenAPI 3.0 specification here..." style="min-height: 150px; font-family: monospace; font-size: 12px;"></textarea>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button class="btn btn-primary" @onclick="SaveConfiguration">Save Configuration</button>
        <button class="btn btn-secondary" @onclick="Discard">Discard Changes</button>
    </div>
}

<style>
    .toggle-switch {
        width: 50px;
        height: 26px;
        background: #ccc;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .toggle-switch.active {
        background: var(--azure-blue);
    }
    
    .toggle-slider {
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: left 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch.active .toggle-slider {
        left: 26px;
    }
</style>

@code {
    [Parameter]
    public WebApp? WebApp { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    private bool mcpEnabled = false;
    private string mcpEndpointPath = "/.well-known/mcp";
    private string mcpServerName = "";
    private string mcpServerDescription = "";
    private List<MCPTool> mcpTools = new();
    private bool showAddTool = false;
    private MCPTool newTool = new();
    private string openApiUrl = "";
    private string openApiSpec = "";

    protected override void OnParametersSet()
    {
        if (WebApp != null && string.IsNullOrEmpty(mcpServerName))
        {
            mcpServerName = $"{WebApp.Name} MCP Server";
        }
    }

    private void ToggleMCP()
    {
        mcpEnabled = !mcpEnabled;
    }

    private void ShowAddToolDialog()
    {
        newTool = new MCPTool { Method = "GET" };
        showAddTool = true;
    }

    private void CancelAddTool()
    {
        showAddTool = false;
        newTool = new MCPTool();
    }

    private void AddParameter()
    {
        newTool.Parameters.Add(new MCPParameter { Type = "string" });
    }

    private void RemoveParameter(MCPParameter param)
    {
        newTool.Parameters.Remove(param);
    }

    private void SaveTool()
    {
        if (!string.IsNullOrWhiteSpace(newTool.Name) && !string.IsNullOrWhiteSpace(newTool.Endpoint))
        {
            mcpTools.Add(newTool);
            showAddTool = false;
            newTool = new MCPTool();
        }
    }

    private void RemoveTool(MCPTool tool)
    {
        mcpTools.Remove(tool);
    }

    private void ImportFromOpenAPI()
    {
        // TODO: Parse OpenAPI spec and generate tools
        Console.WriteLine("Importing from OpenAPI...");
    }

    private async Task SaveConfiguration()
    {
        await OnSave.InvokeAsync();
    }

    private void Discard()
    {
        // Reset to defaults
        mcpEnabled = false;
        mcpTools.Clear();
    }

    public class MCPTool
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Method { get; set; } = "GET";
        public string Endpoint { get; set; } = "";
        public List<MCPParameter> Parameters { get; set; } = new();
    }

    public class MCPParameter
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "string";
        public string Description { get; set; } = "";
        public bool Required { get; set; } = false;
    }
}
