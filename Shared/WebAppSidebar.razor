@inject NavigationManager Navigation

<div class="sidebar webapp-sidebar">
    <div class="webapp-header">
        <div class="webapp-icon">&#127760;</div>
        <div class="webapp-info">
            <div class="webapp-name">@WebAppName</div>
            <div class="webapp-type">Web App</div>
        </div>
    </div>

    <div class="sidebar-search">
        <input type="text" placeholder="Search" class="search-input" />
    </div>

    <ul class="sidebar-menu">
        <li class="sidebar-item @(IsActive("overview") ? "active" : "")" @onclick='() => SetActiveSection("overview")'>
            <span class="sidebar-icon">&#128200;</span>
            <span>Overview</span>
        </li>
        <li class="sidebar-item @(IsActive("activity") ? "active" : "")" @onclick='() => SetActiveSection("activity")'>
            <span class="sidebar-icon">&#128203;</span>
            <span>Activity log</span>
        </li>
        <li class="sidebar-item @(IsActive("access") ? "active" : "")" @onclick='() => SetActiveSection("access")'>
            <span class="sidebar-icon">&#128274;</span>
            <span>Access control (IAM)</span>
        </li>
        <li class="sidebar-item @(IsActive("tags") ? "active" : "")" @onclick='() => SetActiveSection("tags")'>
            <span class="sidebar-icon">#</span>
            <span>Tags</span>
        </li>
        <li class="sidebar-item @(IsActive("diagnose") ? "active" : "")" @onclick='() => SetActiveSection("diagnose")'>
            <span class="sidebar-icon">&#128269;</span>
            <span>Diagnose and solve problems</span>
        </li>
        <li class="sidebar-item @(IsActive("defender") ? "active" : "")" @onclick='() => SetActiveSection("defender")'>
            <span class="sidebar-icon">&#128737;</span>
            <span>Microsoft Defender for Cloud</span>
        </li>
        <li class="sidebar-item @(IsActive("events") ? "active" : "")" @onclick='() => SetActiveSection("events")'>
            <span class="sidebar-icon">&#9889;</span>
            <span>Events (preview)</span>
        </li>
        <li class="sidebar-item @(IsActive("visualizer") ? "active" : "")" @onclick='() => SetActiveSection("visualizer")'>
            <span class="sidebar-icon">&#128260;</span>
            <span>Resource visualizer</span>
        </li>
    </ul>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleAICenter">
            <span class="sidebar-icon">@((MarkupString)(isAICenterExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>AI Center</span>
        </div>
        @if (isAICenterExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("ai-integration") ? "active" : "")" @onclick='() => SetActiveSection("ai-integration")'>
                    <span class="sidebar-icon">&#129302;</span>
                    <span>AI Integration</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleDeployment">
            <span class="sidebar-icon">@((MarkupString)(isDeploymentExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>Deployment</span>
        </div>
        @if (isDeploymentExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("deployment-slots") ? "active" : "")" @onclick='() => SetActiveSection("deployment-slots")'>
                    <span class="sidebar-icon">&#128230;</span>
                    <span>Deployment slots</span>
                </li>
                <li class="sidebar-item @(IsActive("deployment-center") ? "active" : "")" @onclick='() => SetActiveSection("deployment-center")'>
                    <span class="sidebar-icon">&#128640;</span>
                    <span>Deployment Center</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleSettings">
            <span class="sidebar-icon">@((MarkupString)(isSettingsExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>Settings</span>
        </div>
        @if (isSettingsExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("environment") ? "active" : "")" @onclick='() => SetActiveSection("environment")'>
                    <span class="sidebar-icon">&#128260;</span>
                    <span>Environment variables</span>
                </li>
                <li class="sidebar-item @(IsActive("configuration") ? "active" : "")" @onclick='() => SetActiveSection("configuration")'>
                    <span class="sidebar-icon">&#9881;</span>
                    <span>Configuration (preview)</span>
                </li>
                <li class="sidebar-item @(IsActive("instances") ? "active" : "")" @onclick='() => SetActiveSection("instances")'>
                    <span class="sidebar-icon">&#128421;</span>
                    <span>Instances</span>
                </li>
                <li class="sidebar-item @(IsActive("authentication") ? "active" : "")" @onclick='() => SetActiveSection("authentication")'>
                    <span class="sidebar-icon">&#128273;</span>
                    <span>Authentication</span>
                </li>
                <li class="sidebar-item @(IsActive("identity") ? "active" : "")" @onclick='() => SetActiveSection("identity")'>
                    <span class="sidebar-icon">&#128100;</span>
                    <span>Identity</span>
                </li>
                <li class="sidebar-item @(IsActive("backups") ? "active" : "")" @onclick='() => SetActiveSection("backups")'>
                    <span class="sidebar-icon">&#128190;</span>
                    <span>Backups</span>
                </li>
                <li class="sidebar-item @(IsActive("custom-domains") ? "active" : "")" @onclick='() => SetActiveSection("custom-domains")'>
                    <span class="sidebar-icon">&#127760;</span>
                    <span>Custom domains</span>
                </li>
                <li class="sidebar-item @(IsActive("certificates") ? "active" : "")" @onclick='() => SetActiveSection("certificates")'>
                    <span class="sidebar-icon">&#128220;</span>
                    <span>Certificates</span>
                </li>
                <li class="sidebar-item @(IsActive("networking") ? "active" : "")" @onclick='() => SetActiveSection("networking")'>
                    <span class="sidebar-icon">&#128279;</span>
                    <span>Networking</span>
                </li>
                <li class="sidebar-item @(IsActive("webjobs") ? "active" : "")" @onclick='() => SetActiveSection("webjobs")'>
                    <span class="sidebar-icon">&#9889;</span>
                    <span>WebJobs</span>
                </li>
                <li class="sidebar-item @(IsActive("service-connector") ? "active" : "")" @onclick='() => SetActiveSection("service-connector")'>
                    <span class="sidebar-icon">&#128268;</span>
                    <span>Service Connector</span>
                </li>
                <li class="sidebar-item @(IsActive("locks") ? "active" : "")" @onclick='() => SetActiveSection("locks")'>
                    <span class="sidebar-icon">&#128274;</span>
                    <span>Locks</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="TogglePerformance">
            <span class="sidebar-icon">@((MarkupString)(isPerformanceExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>Performance</span>
        </div>
        @if (isPerformanceExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("load-testing") ? "active" : "")" @onclick='() => SetActiveSection("load-testing")'>
                    <span class="sidebar-icon">&#128200;</span>
                    <span>Load Testing</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleAppServicePlan">
            <span class="sidebar-icon">@((MarkupString)(isAppServicePlanExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>App Service plan</span>
        </div>
        @if (isAppServicePlanExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("app-service-plan") ? "active" : "")" @onclick='() => SetActiveSection("app-service-plan")'>
                    <span class="sidebar-icon">&#128230;</span>
                    <span>App Service plan</span>
                </li>
                <li class="sidebar-item @(IsActive("scale-up") ? "active" : "")" @onclick='() => SetActiveSection("scale-up")'>
                    <span class="sidebar-icon">&#8593;</span>
                    <span>Scale up</span>
                </li>
                <li class="sidebar-item @(IsActive("scale-out") ? "active" : "")" @onclick='() => SetActiveSection("scale-out")'>
                    <span class="sidebar-icon">&#8596;</span>
                    <span>Scale out</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleDevTools">
            <span class="sidebar-icon">@((MarkupString)(isDevToolsExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>Development Tools</span>
        </div>
        @if (isDevToolsExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("ssh") ? "active" : "")" @onclick='() => SetActiveSection("ssh")'>
                    <span class="sidebar-icon">&#128433;</span>
                    <span>SSH</span>
                </li>
                <li class="sidebar-item @(IsActive("advanced-tools") ? "active" : "")" @onclick='() => SetActiveSection("advanced-tools")'>
                    <span class="sidebar-icon">&#128295;</span>
                    <span>Advanced Tools</span>
                </li>
                <li class="sidebar-item @(IsActive("recommended-services") ? "active" : "")" @onclick='() => SetActiveSection("recommended-services")'>
                    <span class="sidebar-icon">&#128203;</span>
                    <span>Recommended services (preview)</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleApi">
            <span class="sidebar-icon">@((MarkupString)(isApiExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>API</span>
        </div>
        @if (isApiExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("api-management") ? "active" : "")" @onclick='() => SetActiveSection("api-management")'>
                    <span class="sidebar-icon">&#128203;</span>
                    <span>API Management</span>
                </li>
                <li class="sidebar-item @(IsActive("api-definition") ? "active" : "")" @onclick='() => SetActiveSection("api-definition")'>
                    <span class="sidebar-icon">&#128196;</span>
                    <span>API definition</span>
                </li>
                <li class="sidebar-item @(IsActive("cors") ? "active" : "")" @onclick='() => SetActiveSection("cors")'>
                    <span class="sidebar-icon">&#128279;</span>
                    <span>CORS</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleMonitoring">
            <span class="sidebar-icon">@((MarkupString)(isMonitoringExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>Monitoring</span>
        </div>
        @if (isMonitoringExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("alerts") ? "active" : "")" @onclick='() => SetActiveSection("alerts")'>
                    <span class="sidebar-icon">&#128276;</span>
                    <span>Alerts</span>
                </li>
                <li class="sidebar-item @(IsActive("metrics") ? "active" : "")" @onclick='() => SetActiveSection("metrics")'>
                    <span class="sidebar-icon">&#128202;</span>
                    <span>Metrics</span>
                </li>
                <li class="sidebar-item @(IsActive("logs") ? "active" : "")" @onclick='() => SetActiveSection("logs")'>
                    <span class="sidebar-icon">&#128203;</span>
                    <span>Logs</span>
                </li>
                <li class="sidebar-item @(IsActive("health-check") ? "active" : "")" @onclick='() => SetActiveSection("health-check")'>
                    <span class="sidebar-icon">&#128154;</span>
                    <span>Health check</span>
                </li>
                <li class="sidebar-item @(IsActive("application-insights") ? "active" : "")" @onclick='() => SetActiveSection("application-insights")'>
                    <span class="sidebar-icon">&#128200;</span>
                    <span>Application Insights</span>
                </li>
                <li class="sidebar-item @(IsActive("diagnostic-settings") ? "active" : "")" @onclick='() => SetActiveSection("diagnostic-settings")'>
                    <span class="sidebar-icon">&#128269;</span>
                    <span>Diagnostic settings</span>
                </li>
                <li class="sidebar-item @(IsActive("app-service-logs") ? "active" : "")" @onclick='() => SetActiveSection("app-service-logs")'>
                    <span class="sidebar-icon">&#128203;</span>
                    <span>App Service logs</span>
                </li>
                <li class="sidebar-item @(IsActive("log-stream") ? "active" : "")" @onclick='() => SetActiveSection("log-stream")'>
                    <span class="sidebar-icon">&#128203;</span>
                    <span>Log stream</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleAutomation">
            <span class="sidebar-icon">@((MarkupString)(isAutomationExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>Automation</span>
        </div>
        @if (isAutomationExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("tasks") ? "active" : "")" @onclick='() => SetActiveSection("tasks")'>
                    <span class="sidebar-icon">&#128203;</span>
                    <span>Tasks</span>
                </li>
                <li class="sidebar-item @(IsActive("export-template") ? "active" : "")" @onclick='() => SetActiveSection("export-template")'>
                    <span class="sidebar-icon">&#128196;</span>
                    <span>Export template</span>
                </li>
            </ul>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header" @onclick="ToggleSupport">
            <span class="sidebar-icon">@((MarkupString)(isSupportExpanded ? "&#9660;" : "&#9654;"))</span>
            <span>Support + troubleshooting</span>
        </div>
        @if (isSupportExpanded)
        {
            <ul class="sidebar-submenu">
                <li class="sidebar-item @(IsActive("resource-health") ? "active" : "")" @onclick='() => SetActiveSection("resource-health")'>
                    <span class="sidebar-icon">&#128154;</span>
                    <span>Resource health</span>
                </li>
                <li class="sidebar-item @(IsActive("advisor-recommendations") ? "active" : "")" @onclick='() => SetActiveSection("advisor-recommendations")'>
                    <span class="sidebar-icon">&#128161;</span>
                    <span>Advisor recommendations</span>
                </li>
                <li class="sidebar-item @(IsActive("support-troubleshooting") ? "active" : "")" @onclick='() => SetActiveSection("support-troubleshooting")'>
                    <span class="sidebar-icon">&#10068;</span>
                    <span>Support + Troubleshooting</span>
                </li>
            </ul>
        }
    </div>
</div>

@code {
    [Parameter]
    public string WebAppName { get; set; } = "Web App";

    [Parameter]
    public string WebAppId { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> OnSectionChanged { get; set; }

    private string activeSection = "overview";
    private bool isAICenterExpanded = true;
    private bool isDeploymentExpanded = false;
    private bool isSettingsExpanded = false;
    private bool isPerformanceExpanded = false;
    private bool isAppServicePlanExpanded = false;
    private bool isDevToolsExpanded = false;
    private bool isApiExpanded = false;
    private bool isMonitoringExpanded = false;
    private bool isAutomationExpanded = false;
    private bool isSupportExpanded = false;

    protected override void OnInitialized()
    {
        // Determine active section from current URL
        var uri = Navigation.Uri;
        if (uri.Contains("/webapps/") && uri.Split('/').Length > 3)
        {
            // URL format: /webapps/{id}/{section}
            var parts = uri.Split('/');
            var sectionPart = parts.Length > 3 ? parts[3] : "overview";
            // Remove any query string
            var queryIndex = sectionPart.IndexOf('?');
            activeSection = queryIndex > 0 ? sectionPart.Substring(0, queryIndex) : sectionPart;
        }
        else if (uri.Contains("/webapps/"))
        {
            activeSection = "overview";
        }
    }

    private bool IsActive(string section)
    {
        return activeSection == section;
    }

    private async Task SetActiveSection(string section)
    {
        activeSection = section;
        
        // Navigate based on section type
        if (string.IsNullOrEmpty(WebAppId))
        {
            await OnSectionChanged.InvokeAsync(section);
            return;
        }

        // Sections that map to the main WebAppDetail tabs
        switch (section)
        {
            case "overview":
                Navigation.NavigateTo($"/webapps/{WebAppId}");
                break;
            default:
                // All other sections go to the section page
                Navigation.NavigateTo($"/webapps/{WebAppId}/{section}");
                break;
        }
    }

    private void ToggleAICenter() => isAICenterExpanded = !isAICenterExpanded;
    private void ToggleDeployment() => isDeploymentExpanded = !isDeploymentExpanded;
    private void ToggleSettings() => isSettingsExpanded = !isSettingsExpanded;
    private void TogglePerformance() => isPerformanceExpanded = !isPerformanceExpanded;
    private void ToggleAppServicePlan() => isAppServicePlanExpanded = !isAppServicePlanExpanded;
    private void ToggleDevTools() => isDevToolsExpanded = !isDevToolsExpanded;
    private void ToggleApi() => isApiExpanded = !isApiExpanded;
    private void ToggleMonitoring() => isMonitoringExpanded = !isMonitoringExpanded;
    private void ToggleAutomation() => isAutomationExpanded = !isAutomationExpanded;
    private void ToggleSupport() => isSupportExpanded = !isSupportExpanded;
}
