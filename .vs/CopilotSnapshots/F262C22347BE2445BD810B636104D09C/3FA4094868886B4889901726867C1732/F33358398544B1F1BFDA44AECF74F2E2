@using DevPortal.Models

<div class="card">
    <div class="card-title">AI Integration</div>
    <div class="form-help" style="margin-bottom: 20px;">
        Add AI-powered capabilities to your web application. This creates an AI agent endpoint that can answer questions, 
        perform actions, and interact with your application's data and APIs.
    </div>
    
    <div class="form-group">
        <label class="form-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
            <div class="toggle-switch @(aiEnabled ? "active" : "")" @onclick="ToggleAI">
                <div class="toggle-slider"></div>
            </div>
            <span style="font-weight: 600;">Enable AI Agent</span>
        </label>
        <div class="form-help">
            When enabled, your web app will have an AI-powered chat endpoint that users can interact with.
        </div>
    </div>
</div>

@if (aiEnabled)
{
    <div class="card">
        <div class="card-title">AI Agent Configuration</div>
        
        <div class="form-group">
            <label class="form-label">Chat Endpoint Path</label>
            <input type="text" class="form-input" @bind="chatEndpointPath" placeholder="/ai/chat" />
            <div class="form-help">The URL path where the AI chat interface will be available.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Agent Name</label>
            <input type="text" class="form-input" @bind="agentName" placeholder="AI Assistant" />
            <div class="form-help">The display name for your AI agent.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">System Prompt</label>
            <textarea class="form-textarea" @bind="systemPrompt" placeholder="You are a helpful assistant for..." style="min-height: 100px;"></textarea>
            <div class="form-help">Instructions that define how your AI agent behaves and responds.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Azure OpenAI Project Name</label>
            <input type="text" class="form-input" @bind="azureOpenAiProjectName" placeholder="my-openai-project" />
            <div class="form-help">The name of your Azure OpenAI project resource.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Azure OpenAI Agent Name</label>
            <input type="text" class="form-input" @bind="azureOpenAiAgentName" placeholder="my-agent" />
            <div class="form-help">The name of the agent deployment within your Azure OpenAI project.</div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">RAG (Retrieval Augmented Generation)</div>
        <div class="form-help" style="margin-bottom: 20px;">
            Enable RAG to give your AI agent knowledge about your website's content. The agent will be able to answer 
            questions based on your site's pages and documentation.
        </div>
        
        <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <div class="toggle-switch @(ragEnabled ? "active" : "")" @onclick="ToggleRAG">
                    <div class="toggle-slider"></div>
                </div>
                <span style="font-weight: 600;">Enable Website Knowledge (RAG)</span>
            </label>
            <div class="form-help">
                Automatically crawl and index your website content so the AI can reference it.
            </div>
        </div>
        
        @if (ragEnabled)
        {
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Starting URL for Crawling</label>
                <input type="text" class="form-input" @bind="ragStartUrl" placeholder="/" />
                <div class="form-help">The AI will crawl pages starting from this URL. Use "/" to crawl the entire site.</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">URL Patterns to Include</label>
                <textarea class="form-textarea" @bind="ragIncludePatterns" placeholder="/docs/*&#10;/help/*&#10;/api/*" style="min-height: 80px;"></textarea>
                <div class="form-help">Only crawl URLs matching these patterns (one per line). Leave empty to crawl all pages.</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">URL Patterns to Exclude</label>
                <textarea class="form-textarea" @bind="ragExcludePatterns" placeholder="/admin/*&#10;/login&#10;/api/internal/*" style="min-height: 80px;"></textarea>
                <div class="form-help">Skip URLs matching these patterns (one per line).</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Crawl Depth</label>
                <input type="number" class="form-input" @bind="ragCrawlDepth" min="1" max="10" style="width: 100px;" />
                <div class="form-help">How many levels deep to follow links from the starting URL.</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Re-index Schedule</label>
                <select class="form-select" @bind="ragReindexSchedule">
                    <option value="manual">Manual only</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <div class="form-help">How often to re-crawl and update the knowledge base.</div>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" @onclick="StartCrawl">
                    &#128269; Start Crawl Now
                </button>
                <span style="margin-left: 15px; color: var(--azure-dark-gray); font-size: 13px;">
                    @if (lastCrawlDate.HasValue)
                    {
                        <text>Last crawled: @lastCrawlDate.Value.ToString("MMM dd, yyyy HH:mm")</text>
                    }
                    else
                    {
                        <text>Never crawled</text>
                    }
                </span>
            </div>
        }
    </div>

    <div class="card">
        <div class="card-title">API Tools (Function Calling)</div>
        <div class="form-help" style="margin-bottom: 20px;">
            Give your AI agent the ability to call your application's APIs. Import an OpenAPI specification to 
            automatically configure available tools.
        </div>
        
        <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <div class="toggle-switch @(toolsEnabled ? "active" : "")" @onclick="ToggleTools">
                    <div class="toggle-slider"></div>
                </div>
                <span style="font-weight: 600;">Enable API Tools</span>
            </label>
            <div class="form-help">
                Allow the AI to perform actions by calling your APIs.
            </div>
        </div>
        
        @if (toolsEnabled)
        {
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">OpenAPI 3.0 Specification</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="form-input" @bind="openApiUrl" placeholder="https://your-app.com/swagger/v1/swagger.json" style="flex: 1;" />
                    <button class="btn btn-secondary" @onclick="ImportOpenAPI">Import from URL</button>
                </div>
                <div class="form-help">Or paste your OpenAPI specification directly:</div>
            </div>
            
            <div class="form-group">
                <textarea class="form-textarea" @bind="openApiSpec" placeholder="Paste your OpenAPI 3.0 JSON or YAML here..." style="min-height: 150px; font-family: 'Consolas', monospace; font-size: 12px;"></textarea>
            </div>
            
            @if (importedTools.Any())
            {
                <div style="margin-top: 15px;">
                    <label class="form-label">Imported Tools (@importedTools.Count)</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        @foreach (var tool in importedTools)
                        {
                            <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--azure-gray); border-radius: 4px; font-size: 13px;">
                                <input type="checkbox" @bind="tool.Enabled" />
                                <span style="font-weight: 500;">@tool.Name</span>
                                <span style="color: var(--azure-dark-gray);">(@tool.Method)</span>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>

    <div class="card">
        <div class="card-title">Advanced Settings</div>
        
        <div class="form-group">
            <label class="form-label">Max Tokens per Response</label>
            <input type="number" class="form-input" @bind="maxTokens" min="100" max="4096" style="width: 150px;" />
            <div class="form-help">Maximum length of AI responses.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Temperature</label>
            <input type="range" @bind="temperature" min="0" max="2" step="0.1" style="width: 200px;" />
            <span style="margin-left: 10px;">@temperature</span>
            <div class="form-help">Controls randomness. Lower values are more focused, higher values more creative.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <div class="toggle-switch @(streamingEnabled ? "active" : "")" @onclick="() => streamingEnabled = !streamingEnabled">
                    <div class="toggle-slider"></div>
                </div>
                <span>Enable Streaming Responses</span>
            </label>
            <div class="form-help">Stream responses token by token for a more responsive feel.</div>
        </div>
        
        <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <div class="toggle-switch @(loggingEnabled ? "active" : "")" @onclick="() => loggingEnabled = !loggingEnabled">
                    <div class="toggle-slider"></div>
                </div>
                <span>Enable Conversation Logging</span>
            </label>
            <div class="form-help">Log all conversations for analysis and debugging.</div>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button class="btn btn-primary" @onclick="SaveConfiguration">Save Configuration</button>
        <button class="btn btn-secondary" @onclick="Discard">Discard Changes</button>
        <button class="btn btn-secondary" style="margin-left: 20px;" @onclick="TestAgent">
            &#129302; Test AI Agent
        </button>
    </div>
}

<style>
    .toggle-switch {
        width: 50px;
        height: 26px;
        background: #ccc;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .toggle-switch.active {
        background: var(--azure-blue);
    }
    
    .toggle-slider {
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: left 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch.active .toggle-slider {
        left: 26px;
    }
</style>

@code {
    [Parameter]
    public WebApp? WebApp { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    // Main toggles
    private bool aiEnabled = false;
    private bool ragEnabled = false;
    private bool toolsEnabled = false;
    
    // AI Agent settings
    private string chatEndpointPath = "/ai/chat";
    private string agentName = "AI Assistant";
    private string systemPrompt = "";
    private string selectedModel = "gpt-4o";
    private string openAiApiKey = "";
    
    // RAG settings
    private string ragStartUrl = "/";
    private string ragIncludePatterns = "";
    private string ragExcludePatterns = "/admin/*\n/login\n/logout";
    private int ragCrawlDepth = 3;
    private string ragReindexSchedule = "weekly";
    private DateTime? lastCrawlDate = null;
    
    // Tools settings
    private string openApiUrl = "";
    private string openApiSpec = "";
    private List<ImportedTool> importedTools = new();
    
    // Advanced settings
    private int maxTokens = 1024;
    private double temperature = 0.7;
    private bool streamingEnabled = true;
    private bool loggingEnabled = true;

    protected override void OnParametersSet()
    {
        if (WebApp != null && string.IsNullOrEmpty(systemPrompt))
        {
            systemPrompt = $"You are a helpful AI assistant for {WebApp.Name}. Help users with their questions and tasks.";
        }
    }

    private void ToggleAI() => aiEnabled = !aiEnabled;
    private void ToggleRAG() => ragEnabled = !ragEnabled;
    private void ToggleTools() => toolsEnabled = !toolsEnabled;

    private void StartCrawl()
    {
        // TODO: Implement actual crawling
        lastCrawlDate = DateTime.Now;
        Console.WriteLine($"Starting crawl from {ragStartUrl}...");
    }

    private void ImportOpenAPI()
    {
        // TODO: Parse OpenAPI and populate importedTools
        importedTools = new List<ImportedTool>
        {
            new ImportedTool { Name = "getUsers", Method = "GET", Endpoint = "/api/users", Enabled = true },
            new ImportedTool { Name = "createUser", Method = "POST", Endpoint = "/api/users", Enabled = true },
            new ImportedTool { Name = "getProducts", Method = "GET", Endpoint = "/api/products", Enabled = true },
        };
        Console.WriteLine("Imported OpenAPI specification");
    }

    private void TestAgent()
    {
        // TODO: Open test chat dialog
        Console.WriteLine("Testing AI agent...");
    }

    private async Task SaveConfiguration()
    {
        await OnSave.InvokeAsync();
    }

    private void Discard()
    {
        aiEnabled = false;
        ragEnabled = false;
        toolsEnabled = false;
    }

    private class ImportedTool
    {
        public string Name { get; set; } = "";
        public string Method { get; set; } = "";
        public string Endpoint { get; set; } = "";
        public bool Enabled { get; set; } = true;
    }
}
