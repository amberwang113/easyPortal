@using DevPortal.Models

<div class="card">
    <div class="card-title">General Settings</div>
    
    <div class="form-group">
        <label class="form-label">
            <input type="checkbox" @bind="WebApp.AlwaysOn" /> Always On
        </label>
        <div class="form-help">Keep the app loaded even when there's no traffic. Required for continuous WebJobs or WebJobs triggered using a CRON expression.</div>
    </div>
    
    <div class="form-group">
        <label class="form-label">
            <input type="checkbox" @bind="WebApp.HttpsOnly" /> HTTPS Only
        </label>
        <div class="form-help">Redirect all HTTP traffic to HTTPS.</div>
    </div>
    
    <div class="form-group">
        <label class="form-label">HTTP Version</label>
        <select class="form-select" @bind="WebApp.HttpVersion">
            <option value="1.1">1.1</option>
            <option value="2.0">2.0</option>
        </select>
    </div>
    
    <div class="form-group">
        <label class="form-label">
            <input type="checkbox" @bind="WebApp.WebSocketsEnabled" /> WebSockets
        </label>
        <div class="form-help">Enable WebSocket protocol for your app.</div>
    </div>
</div>

<div class="card">
    <div class="card-title">Application Settings</div>
    <div class="form-help" style="margin-bottom: 15px;">
        Application settings are environment variables that are available to your application code.
    </div>
    
    @if (WebApp.AppSettings.Any())
    {
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var setting in WebApp.AppSettings)
                {
                    <tr>
                        <td style="font-family: monospace;">@setting.Key</td>
                        <td style="font-family: monospace;">@MaskValue(setting.Value)</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" @onclick="() => RemoveSetting(setting.Key)">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">No application settings configured.</div>
    }
    
    <div style="margin-top: 15px;">
        <button class="btn btn-secondary" @onclick="AddNewSetting">+ Add Setting</button>
    </div>
</div>

<div class="card">
    <div class="card-title">Connection Strings</div>
    <div class="form-help" style="margin-bottom: 15px;">
        Connection strings for databases and other data sources.
    </div>
    
    @if (WebApp.ConnectionStrings.Any())
    {
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var connectionString in WebApp.ConnectionStrings)
                {
                    <tr>
                        <td style="font-family: monospace;">@connectionString.Key</td>
                        <td style="font-family: monospace;">@MaskValue(connectionString.Value)</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" @onclick="() => RemoveConnectionString(connectionString.Key)">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert alert-info">No connection strings configured.</div>
    }
    
    <div style="margin-top: 15px;">
        <button class="btn btn-secondary" @onclick="AddNewConnectionString">+ Add Connection String</button>
    </div>
</div>

<div style="margin-top: 20px;">
    <button class="btn btn-primary" @onclick="Save">Save</button>
    <button class="btn btn-secondary" @onclick="Discard">Discard</button>
</div>

@code {
    [Parameter]
    public WebApp WebApp { get; set; } = null!;
    
    [Parameter]
    public EventCallback OnSave { get; set; }

    private void OnChange()
    {
        StateHasChanged();
    }

    private string MaskValue(string value)
    {
        if (string.IsNullOrEmpty(value) || value.Length < 8)
            return "••••••••";
        return value.Substring(0, 4) + "••••••••" + value.Substring(value.Length - 4);
    }

    private void AddNewSetting()
    {
        // TODO: Implement add setting dialog
        var key = $"NEW_SETTING_{WebApp.AppSettings.Count + 1}";
        WebApp.AppSettings[key] = "value";
        StateHasChanged();
    }

    private void RemoveSetting(string key)
    {
        WebApp.AppSettings.Remove(key);
        StateHasChanged();
    }

    private void AddNewConnectionString()
    {
        // TODO: Implement add connection string dialog
        var key = $"ConnectionString{WebApp.ConnectionStrings.Count + 1}";
        WebApp.ConnectionStrings[key] = "Server=...;Database=...;";
        StateHasChanged();
    }

    private void RemoveConnectionString(string key)
    {
        WebApp.ConnectionStrings.Remove(key);
        StateHasChanged();
    }

    private async Task Save()
    {
        await OnSave.InvokeAsync();
    }

    private void Discard()
    {
        // TODO: Reload original values
        StateHasChanged();
    }
}
