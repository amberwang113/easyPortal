@page "/webapp/{Id}/section/{Section}"
@layout PortalLayout
@using DevPortal.Models
@using DevPortal.Services
@using DevPortal.Components.WebApp
@inject ApiService ApiService
@inject NavigationManager Navigation
@implements IDisposable

@if (webApp == null)
{
    <div style="text-align: center; padding: 40px;">
        <div class="loading-spinner"></div>
        <p style="margin-top: 15px;">Loading...</p>
    </div>
}
else
{
    <div class="breadcrumb">
        <span class="breadcrumb-item" @onclick='() => Navigation.NavigateTo("/portal")'>Web Apps</span>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-item" @onclick='() => Navigation.NavigateTo($"/webapp/{Id}")'>@webApp.Name</span>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">@GetSectionDisplayName()</span>
    </div>

    <div class="page-header">
        <div class="page-title">@GetSectionDisplayName()</div>
        <div class="page-subtitle">
            @webApp.Name | @webApp.ResourceGroup
        </div>
    </div>

    <div class="content-wrapper">
        @switch (Section)
        {
            case "configure-ai-tools":
                <ConfigureAITools WebApp="@webApp" OnSave="SaveConfiguration" />
                break;
            case "mcp-development":
                <MCPDevelopment WebApp="@webApp" OnSave="SaveConfiguration" />
                break;
            default:
                <NotImplemented 
                    SectionName="@GetSectionDisplayName()" 
                    Title="@GetSectionDisplayName()"
                    WebAppName="@webApp.Name"
                    OnGoBack="GoBackToOverview" />
                break;
        }
    </div>
}

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    [Parameter]
    public string Section { get; set; } = string.Empty;

    [CascadingParameter]
    public PortalLayout? Layout { get; set; }

    private WebApp? webApp;

    protected override async Task OnInitializedAsync()
    {
        await LoadWebApp();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (webApp?.Id != Id)
        {
            await LoadWebApp();
        }
    }

    private async Task LoadWebApp()
    {
        try
        {
            webApp = await ApiService.GetWebAppAsync(Id);
            if (webApp == null)
            {
                Navigation.NavigateTo("/portal");
            }
            else
            {
                Layout?.SetWebAppContext(webApp.Name, webApp.Id, EventCallback.Factory.Create<string>(this, HandleSidebarSectionChanged));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading web app: {ex.Message}");
            Navigation.NavigateTo("/portal");
        }
    }

    private void HandleSidebarSectionChanged(string section)
    {
        NavigateToSection(section);
    }

    private void NavigateToSection(string section)
    {
        // Sections that have full implementations go to the main WebAppDetail page with a tab
        var implementedSections = new[] { "overview", "configuration", "environment", "deployment-center", "deployment-slots", "networking", "scale-up", "scale-out", "app-service-plan" };
        
        if (section == "overview")
        {
            Navigation.NavigateTo($"/webapp/{Id}");
        }
        else if (implementedSections.Contains(section))
        {
            Navigation.NavigateTo($"/webapp/{Id}?tab={MapSectionToTab(section)}");
        }
        else
        {
            Navigation.NavigateTo($"/webapp/{Id}/section/{section}");
        }
    }

    private string MapSectionToTab(string section)
    {
        return section switch
        {
            "configuration" or "environment" => "configuration",
            "deployment-center" or "deployment-slots" => "deployment",
            "networking" => "networking",
            "scale-up" or "scale-out" or "app-service-plan" => "scale",
            _ => "overview"
        };
    }

    private void GoBackToOverview()
    {
        Navigation.NavigateTo($"/webapp/{Id}");
    }

    public void Dispose()
    {
        Layout?.ClearWebAppContext();
    }

    private string GetSectionDisplayName()
    {
        return Section switch
        {
            // Top-level items
            "activity" => "Activity Log",
            "access" => "Access Control (IAM)",
            "tags" => "Tags",
            "diagnose" => "Diagnose and Solve Problems",
            "defender" => "Microsoft Defender for Cloud",
            "events" => "Events (Preview)",
            "visualizer" => "Resource Visualizer",
            
            // AI Center
            "configure-ai-tools" => "Configure AI Tools",
            "mcp-development" => "MCP Development",
            
            // Deployment
            "deployment-slots" => "Deployment Slots",
            "deployment-center" => "Deployment Center",
            
            // Settings
            "environment" => "Environment Variables",
            "configuration" => "Configuration",
            "instances" => "Instances",
            "authentication" => "Authentication",
            "identity" => "Identity",
            "backups" => "Backups",
            "custom-domains" => "Custom Domains",
            "certificates" => "Certificates",
            "networking" => "Networking",
            "webjobs" => "WebJobs",
            "service-connector" => "Service Connector",
            "locks" => "Locks",
            
            // Performance
            "load-testing" => "Load Testing",
            
            // App Service plan
            "app-service-plan" => "App Service Plan",
            "scale-up" => "Scale Up",
            "scale-out" => "Scale Out",
            
            // Development Tools
            "ssh" => "SSH",
            "advanced-tools" => "Advanced Tools",
            "recommended-services" => "Recommended Services (Preview)",
            
            // API
            "api-management" => "API Management",
            "api-definition" => "API Definition",
            "cors" => "CORS",
            
            // Monitoring
            "alerts" => "Alerts",
            "metrics" => "Metrics",
            "logs" => "Logs",
            "health-check" => "Health Check",
            "application-insights" => "Application Insights",
            "diagnostic-settings" => "Diagnostic Settings",
            "app-service-logs" => "App Service Logs",
            "log-stream" => "Log Stream",
            
            // Automation
            "tasks" => "Tasks",
            "export-template" => "Export Template",
            
            // Support + troubleshooting
            "resource-health" => "Resource Health",
            "advisor-recommendations" => "Advisor Recommendations",
            "support-troubleshooting" => "Support + Troubleshooting",
            
            // Legacy/other
            "monitoring" => "Monitoring",
            _ => Section.Replace("-", " ").ToUpperInvariant()
        };
    }
}
